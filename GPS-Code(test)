#include <Adafruit_GPS.h>

// ESP32 UART2 pins (common/default choice)
static const int GPS_RX_PIN = 16; // ESP32 receives on this pin  <- GPS TX
static const int GPS_TX_PIN = 17; // ESP32 transmits on this pin -> GPS RX

HardwareSerial GPSSerial(2);          // UART2 on ESP32
Adafruit_GPS GPS(&GPSSerial);

uint32_t lastPrint = 0;

void setup() {
  Serial.begin(115200);
  delay(500);

  Serial.println("\nESP32 + Adafruit Ultimate GPS v3 test");

  // Start UART2 with chosen pins
  GPSSerial.begin(9600, SERIAL_8N1, GPS_RX_PIN, GPS_TX_PIN);

  // Init GPS
  GPS.begin(9600);

  // Recommended config:
  // - Output RMC + GGA (enough for fix, location, satellites, altitude)
  // - Update rate 1Hz (reliable for testing)
  GPS.sendCommand(PMTK_SET_NMEA_OUTPUT_RMCGGA);
  GPS.sendCommand(PMTK_SET_NMEA_UPDATE_1HZ);
  GPS.sendCommand(PGCMD_ANTENNA);

  delay(1000);

  // Optional: ask for firmware version
  GPSSerial.println(PMTK_Q_RELEASE);

  Serial.println("Waiting for GPS data...");
}

void loop() {
  // Read data from GPS as fast as possible
  char c = GPS.read();

  // OPTIONAL RAW NMEA DEBUG:
  // Uncomment to see raw NMEA characters in Serial Monitor
  // if (c) Serial.write(c);

  // Parse new NMEA sentences when available
  if (GPS.newNMEAreceived()) {
    // If you want to see the last full sentence:
    // Serial.println(GPS.lastNMEA());

    if (!GPS.parse(GPS.lastNMEA())) {
      // parsing failed; skip this round
      return;
    }
  }

  // Print status once per second
  if (millis() - lastPrint > 1000) {
    lastPrint = millis();

    Serial.print("Fix: ");
    Serial.print((int)GPS.fix);
    Serial.print("  Sat: ");
    Serial.print((int)GPS.satellites);

    if (GPS.fix) {
      Serial.print("  Lat: ");
      Serial.print(GPS.latitude, 6);
      Serial.print(GPS.lat);

      Serial.print("  Lon: ");
      Serial.print(GPS.longitude, 6);
      Serial.print(GPS.lon);

      Serial.print("  Speed(knots): ");
      Serial.print(GPS.speed);

      Serial.print("  Angle: ");
      Serial.print(GPS.angle);

      Serial.print("  Alt(m): ");
      Serial.print(GPS.altitude);

      Serial.print("  Time: ");
      if (GPS.hour < 10) Serial.print('0');
      Serial.print(GPS.hour); Serial.print(':');
      if (GPS.minute < 10) Serial.print('0');
      Serial.print(GPS.minute); Serial.print(':');
      if (GPS.seconds < 10) Serial.print('0');
      Serial.print(GPS.seconds);
    }

    Serial.println();
  }
}
